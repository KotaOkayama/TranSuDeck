name: TranSuDeck CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Lint with flake8
      run: |
        # Python syntax errors or undefined names
        flake8 app/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # All errors as warnings
        flake8 app/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Check formatting with black
      run: |
        black --check app/ tests/
      continue-on-error: true

    - name: Check import sorting with isort
      run: |
        isort --check-only app/ tests/
      continue-on-error: true

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Create necessary directories
      run: |
        mkdir -p uploads downloads logs outputs
        chmod 777 uploads downloads logs outputs

    - name: Create test environment file
      run: |
        cat > .env << EOF
        GENAI_HUB_API_KEY=test_key_for_ci
        GENAI_HUB_API_URL=https://api.test.example.com
        DEBUG=true
        LOG_LEVEL=debug
        PYTHONUNBUFFERED=1
        EOF

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-python-${{ matrix.python-version }}
        fail_ci_if_error: false

    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          htmlcov/
          coverage.xml
        retention-days: 30

  docker-build:
    name: Docker Build and Test
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        echo "ğŸ³ Building Docker image..."
        docker build -t transudeck:test -f docker/Dockerfile .
        echo "âœ… Docker image built successfully"
        docker images | grep transudeck

    - name: Create test environment
      run: |
        echo "ğŸ“ Creating test environment..."
        mkdir -p uploads downloads logs outputs
        chmod 777 uploads downloads logs outputs
        
        cat > .env.test << EOF
        GENAI_HUB_API_KEY=test_key_for_ci
        GENAI_HUB_API_URL=https://api.test.example.com
        DEBUG=true
        LOG_LEVEL=debug
        PYTHONUNBUFFERED=1
        EOF

    - name: Start container
      run: |
        echo "ğŸš€ Starting container..."
        docker run --rm -d \
          -p 8001:8001 \
          --env-file .env.test \
          -v "$(pwd)/uploads:/app/uploads" \
          -v "$(pwd)/downloads:/app/downloads" \
          -v "$(pwd)/logs:/app/logs" \
          -v "$(pwd)/outputs:/app/outputs" \
          --name transudeck-test \
          transudeck:test
        
        echo "â³ Waiting for container initialization..."
        sleep 10

    - name: Check container health
      run: |
        echo "ğŸ” Checking container status..."
        docker ps -a
        
        echo "ğŸ“‹ Container logs:"
        docker logs transudeck-test || true
        
        if ! docker ps | grep transudeck-test; then
          echo "âŒ Container stopped unexpectedly. Full logs:"
          docker logs transudeck-test || true
          exit 1
        fi
        
        echo "âœ… Container is running"

    - name: Wait for application
      run: |
        echo "â³ Waiting for application to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:8001/ > /dev/null; then
            echo "âœ… Application is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Application failed to start within 60 seconds"
            echo "Container logs:"
            docker logs transudeck-test
            exit 1
          fi
          echo "Attempt $i/30: Waiting..."
          sleep 2
        done

    - name: Test endpoints
      run: |
        echo "ğŸ§ª Testing endpoints..."
        
        echo "Testing root endpoint..."
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/)
        echo "Response code: $RESPONSE"
        if [ "$RESPONSE" != "200" ]; then
          echo "âŒ Root endpoint test failed"
          docker logs transudeck-test
          exit 1
        fi
        echo "âœ… Root endpoint test passed"
        
        echo "Testing health endpoint..."
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/health || echo "000")
        echo "Response code: $RESPONSE"
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… Health endpoint test passed"
        else
          echo "âš ï¸ Health endpoint not available (this is OK if not implemented)"
        fi
        
        echo "âœ… All endpoint tests completed!"

    - name: Show final container logs
      if: always()
      run: |
        echo "ğŸ“‹ Final container logs:"
        docker logs transudeck-test || true

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        docker stop transudeck-test || true
        docker rm transudeck-test || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, docker-build, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          # ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if git describe --tags --abbrev=0 2>/dev/null; then
            LATEST_TAG=$(git describe --tags --abbrev=0)
            echo "is_first_release=false" >> $GITHUB_OUTPUT
          else
            LATEST_TAG="v0.0.0"
            echo "is_first_release=true" >> $GITHUB_OUTPUT
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Latest tag: $LATEST_TAG"

      - name: Determine version bump
        id: version_bump
        run: |
          # PRã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          IS_FIRST_RELEASE="${{ steps.get_tag.outputs.is_first_release }}"
          
          # PRã‚¿ã‚¤ãƒˆãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
          if [ -n "$PR_TITLE" ]; then
            CHECK_TEXT="$PR_TITLE"
            echo "ğŸ“ Checking PR title: $PR_TITLE"
          else
            CHECK_TEXT="$COMMIT_MSG"
            echo "ğŸ“ Checking commit message: $COMMIT_MSG"
          fi
          
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
          if [ "$IS_FIRST_RELEASE" = "true" ]; then
            MAJOR=0
            MINOR=1
            PATCH=0
            BUMP_TYPE="Initial Release"
            echo "ğŸ‰ Initial release detected"
          # [major], [minor], [patch] ã®ã„ãšã‚Œã‹ã‚’ãƒã‚§ãƒƒã‚¯
          elif [[ $CHECK_TEXT =~ \[major\] ]] || [[ $CHECK_TEXT =~ \[MAJOR\] ]]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="Major Version"
            echo "ğŸš€ Major version bump detected"
          elif [[ $CHECK_TEXT =~ \[minor\] ]] || [[ $CHECK_TEXT =~ \[MINOR\] ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="Minor Version"
            echo "ğŸ“¦ Minor version bump detected"
          elif [[ $CHECK_TEXT =~ \[patch\] ]] || [[ $CHECK_TEXT =~ \[PATCH\] ]]; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="Patch Version"
            echo "ğŸ”§ Patch version bump detected"
          else
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
            PATCH=$((PATCH + 1))
            BUMP_TYPE="Patch Version"
            echo "ğŸ”§ Default patch version bump"
          fi
          
          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "version=$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT
          echo "ğŸ‰ New version: $NEW_TAG ($BUMP_TYPE)"

      - name: Create and push tag
        run: |
          NEW_TAG="${{ steps.version_bump.outputs.new_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $NEW_TAG -m "Release $NEW_TAG"
          git push origin $NEW_TAG

      - name: Generate changelog
        id: changelog
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          NEW_TAG="${{ steps.version_bump.outputs.new_tag }}"
          IS_FIRST_RELEASE="${{ steps.get_tag.outputs.is_first_release }}"
          
          echo "Generating changelog from $LATEST_TAG to $NEW_TAG"
          
          # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¯å…¨ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          if [ "$IS_FIRST_RELEASE" = "true" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="- Initial release"
            fi
          else
            # å‰å›ã®ã‚¿ã‚°ã‹ã‚‰ã®å¤‰æ›´ã‚’å–å¾—
            CHANGELOG=$(git log $LATEST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="- Minor updates and improvements"
            fi
          fi
          
          # Save to file for multiline output
          cat > changelog.txt << EOF
          $CHANGELOG
          EOF
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        run: |
          gh release create ${{ steps.version_bump.outputs.new_tag }} \
            --title "TranSuDeck ${{ steps.version_bump.outputs.new_tag }}" \
            --notes "## ğŸš€ ${{ steps.version_bump.outputs.bump_type }} Release
          
          ### ğŸ“ What's Changed
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ”— Links
          - **Documentation**: https://github.com/${{ github.repository }}/blob/main/README.md
          
          ### ğŸ“¦ Docker Image
          Pull the latest image:
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version_bump.outputs.version }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          Run with Docker:
          \`\`\`bash
          docker run -d -p 8001:8001 \\
            -e GENAI_HUB_API_KEY=your_key \\
            -e GENAI_HUB_API_URL=your_url \\
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          ### ğŸ¯ Features
          - ğŸŒ Multi-language translation via GenAI Hub
          - ğŸ“ Automatic text summarization
          - ğŸ“Š PowerPoint (PPTX) generation
          - ğŸ¨ Modern 2-column UI
          - ğŸ”§ Easy configuration via web interface"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ steps.version_bump.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version_bump.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.version_bump.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version_bump.outputs.version }}
